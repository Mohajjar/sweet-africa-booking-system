<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking - Sweet Africa Global LLC</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
</head>
<body class="bg-gray-100">

    <header>
    <nav>
        <div class="logo">
            <a href="index.html">Sweet Africa Global LLC</a>
        </div>
        <button id="mobile-menu-btn" aria-label="Open Menu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links">
            <a href="profile.html">My Account</a>
            <button id="logout-button">Log Out</button>
        </div>
    </nav>
</header>

    <div class="main-container">
        <div class="page-wrapper">
            <div class="booking-container">
                <div id="booking-form-placeholder"></div>
            </div>
            <div class="summary-container">
                <div id="summary-placeholder"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjKL8-QPcOKIXCC9L3K9EVRy2LfAcEhxI",
            authDomain: "sweet-africa-bookings.firebaseapp.com",
            projectId: "sweet-africa-bookings",
            storageBucket: "sweet-africa-bookings.firebasestorage.app",
            messagingSenderId: "950167391030",
            appId: "1:950167391030:web:1085602775ce912d220197"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const bookingState = {
            industry: 'Home Cleaning', service: 'Standard Clean', bedrooms: 1, bathrooms: 1, extras: [],
            isPartialCleaning: false, excludedItems: {}, date: 'Not Selected', time: 'Not Selected',
            customerName: '', customerEmail: '', customerPhone: '', customerAddress: '', customerApartment: ''
        };

        const pricing = {
            basePrice: 25.00, perBedroom: 15.50, perBathroom: 20.25,
            extras: { organization: 30.00, laundry: 25.00, dishes: 20.00 },
            deductions: { bedroom: -5.00, fullBathroom: -10.00, halfBathroom: -7.00, kitchen: -12.00, livingRoom: -8.00, basement: -20.00 }
        };

        function calculatePrice() {
            let total = pricing.basePrice;
            total += ((bookingState.bedrooms || 0) * pricing.perBedroom);
            total += ((bookingState.bathrooms || 0) * pricing.perBathroom);
            bookingState.extras.forEach(extra => { total += (pricing.extras[extra] || 0); });
            if (bookingState.isPartialCleaning) {
                for (const item in bookingState.excludedItems) {
                    total += ((bookingState.excludedItems[item] || 0) * (pricing.deductions[item] || 0));
                }
            }
            return Math.max(total, 0);
        }

        function updateSummary() {
            const summaryCard = document.getElementById("summary-placeholder");
            if (!summaryCard || !summaryCard.innerHTML) return;
            document.getElementById('summary-industry').textContent = bookingState.industry;
            document.getElementById('summary-service').textContent = bookingState.service;
            document.getElementById('summary-bedrooms').textContent = bookingState.bedrooms;
            document.getElementById('summary-bathrooms').textContent = bookingState.bathrooms;
            document.getElementById('summary-date').textContent = bookingState.date;
            document.getElementById('summary-time').textContent = bookingState.time;
            document.getElementById('summary-name').textContent = bookingState.customerName || '-';
            document.getElementById('summary-email').textContent = bookingState.customerEmail || '-';
            document.getElementById('summary-phone').textContent = bookingState.customerPhone || '-';
            const fullAddress = bookingState.customerApartment ? `${bookingState.customerAddress}, ${bookingState.customerApartment}` : bookingState.customerAddress;
            document.getElementById('summary-address').textContent = fullAddress || '-';
            const finalPrice = calculatePrice();
            const formattedPrice = `$${finalPrice.toFixed(2)}`;
            document.getElementById('summary-subtotal').textContent = formattedPrice;
            document.getElementById('summary-total').textContent = formattedPrice;
            const extrasListDiv = document.getElementById('summary-extras-list');
            extrasListDiv.innerHTML = '';
            bookingState.extras.forEach(name => {
                const el = document.createElement('div');
                el.classList.add('summary-item');
                el.innerHTML = `<span>${name.charAt(0).toUpperCase() + name.slice(1)}</span><span>+ $${pricing.extras[name].toFixed(2)}</span>`;
                extrasListDiv.appendChild(el);
            });
            if (bookingState.isPartialCleaning) {
                for (const item in bookingState.excludedItems) {
                    if (bookingState.excludedItems[item] > 0) {
                        const count = bookingState.excludedItems[item];
                        const deduction = pricing.deductions[item];
                        const itemName = item.replace(/([A-Z])/g, ' $1').trim();
                        const el = document.createElement('div');
                        el.classList.add('summary-item');
                        el.innerHTML = `<span>- ${count} ${itemName}</span><span>- $${(Math.abs(deduction) * count).toFixed(2)}</span>`;
                        extrasListDiv.appendChild(el);
                    }
                }
            }
        }
        
        function attachAllEventListeners() {
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    bookingState.industry = card.dataset.industry;
                    bookingState.service = card.dataset.serviceName;
                    updateSummary();
                });
            });
            document.querySelectorAll('.quantity-input').forEach(container => {
                const minusBtn = container.querySelector('.quantity-minus');
                const plusBtn = container.querySelector('.quantity-plus');
                const input = container.querySelector('input');
                const roomType = container.parentElement.querySelector('label').textContent.toLowerCase();
                minusBtn.addEventListener('click', () => {
                    let count = parseInt(input.value);
                    if (count > 1) {
                        count--;
                        input.value = count;
                        bookingState[roomType] = count;
                        updateSummary();
                    }
                });
                plusBtn.addEventListener('click', () => {
                    let count = parseInt(input.value);
                    count++;
                    input.value = count;
                    bookingState[roomType] = count;
                    updateSummary();
                });
            });
            document.querySelectorAll('.extra-card').forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('selected');
                    const extraName = card.dataset.extra;
                    if (bookingState.extras.includes(extraName)) {
                        bookingState.extras = bookingState.extras.filter(e => e !== extraName);
                    } else {
                        bookingState.extras.push(extraName);
                    }
                    updateSummary();
                });
            });
            flatpickr("#date-picker", {
                minDate: "today", dateFormat: "F j, Y",
                onChange: (selectedDates, dateStr) => {
                    bookingState.date = dateStr;
                    updateSummary();
                }
            });
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', () => {
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    slot.classList.add('selected');
                    bookingState.time = slot.textContent;
                    updateSummary();
                });
            });
            const fullNameInput = document.getElementById('full-name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const addressInput = document.getElementById('address');
            const apartmentInput = document.getElementById('apartment');
            const termsCheckbox = document.getElementById('terms-checkbox');
            const completeButton = document.getElementById('complete-booking-btn');
            fullNameInput.value = bookingState.customerName;
            emailInput.value = bookingState.customerEmail;
            
            const validateForm = () => {
                const isNameValid = fullNameInput.value.trim() !== '';
                const isEmailValid = emailInput.value.trim().includes('@');
                const areTermsAccepted = termsCheckbox.checked;
                completeButton.disabled = !(isNameValid && isEmailValid && areTermsAccepted);
            };

            fullNameInput.addEventListener('input', () => { bookingState.customerName = fullNameInput.value; updateSummary(); validateForm(); });
            emailInput.addEventListener('input', () => { bookingState.customerEmail = emailInput.value; updateSummary(); validateForm(); });
            phoneInput.addEventListener('input', (e) => {
                const digits = e.target.value.replace(/\D/g, '').substring(0, 10);
                let formatted = `(${digits.substring(0, 3)}`;
                if (digits.length > 3) formatted += `) ${digits.substring(3, 6)}`;
                if (digits.length > 6) formatted += `-${digits.substring(6, 10)}`;
                e.target.value = formatted;
                bookingState.customerPhone = `+1 ${formatted}`;
                updateSummary();
            });
            addressInput.addEventListener('input', () => { bookingState.customerAddress = addressInput.value; updateSummary(); });
            apartmentInput.addEventListener('input', () => { bookingState.customerApartment = apartmentInput.value; updateSummary(); });
            
            // --- AUTOMATIC INPUT FORMATTING ---
            const cardNumberInput = document.getElementById('card-number');
            const expiryDateInput = document.getElementById('expiry-date');

            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    const formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                    e.target.value = formattedValue;
                });
            }
            if (expiryDateInput) {
                expiryDateInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }
            
            termsCheckbox.addEventListener('change', validateForm);
            document.getElementById('payment-card').addEventListener('change', () => { document.getElementById('credit-card-info').style.display = 'block'; });
            document.getElementById('payment-cash').addEventListener('change', () => { document.getElementById('credit-card-info').style.display = 'none'; });
            completeButton.addEventListener('click', async () => {
                if (completeButton.disabled) return;
                const bookingData = { ...bookingState, totalPrice: calculatePrice(), status: 'Pending' };
                try {
                    await addDoc(collection(db, "bookings"), bookingData);
                    alert('Thank you! Your booking is complete.');
                    window.location.reload();
                } catch (error) {
                    console.error("Error creating booking:", error);
                    alert("There was an error submitting your booking.");
                }
            });
            validateForm();
        }

        async function loadAllComponents() {
            try {
                const [formRes, summaryRes] = await Promise.all([
                    fetch('sections/booking_form/booking_form.html'),
                    fetch('sections/summary_card/summary_card.html')
                ]);
                if (!formRes.ok || !summaryRes.ok) throw new Error("Failed to load component HTML");
                document.getElementById('booking-form-placeholder').innerHTML = await formRes.text();
                document.getElementById('summary-placeholder').innerHTML = await summaryRes.text();
                const formCss = document.createElement('link');
                formCss.rel = 'stylesheet'; formCss.href = 'sections/booking_form/booking_form.css';
                document.head.appendChild(formCss);
                const summaryCss = document.createElement('link');
                summaryCss.rel = 'stylesheet'; summaryCss.href = 'sections/summary_card/summary_card.css';
                document.head.appendChild(summaryCss);
                attachAllEventListeners();
                updateSummary();
            } catch (error) {
                console.error("Failed to load page components:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
            const userData = userDocSnap.data();
            bookingState.customerName = userData.name || '';
            bookingState.customerEmail = userData.email || '';
        }
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        // --- Mobile Menu Toggle Logic ---
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const nav = document.querySelector('nav');
        mobileMenuBtn.addEventListener('click', () => {
            nav.classList.toggle('nav-open');
        });

        await loadAllComponents();
    } else {
        window.location.href = 'login.html';
    }
});
    </script>
</body>
</html>