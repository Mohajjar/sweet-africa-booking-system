<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking - Sweet Africa Global LLC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <link rel="stylesheet" href="css/global.css">
</head>
<body class="bg-gray-100">

    <!-- New Professional Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="index.html" class="text-xl font-bold text-gray-800 hover:text-blue-500 transition">Sweet Africa Global LLC</a>
                </div>
                <!-- CORRECTED BUTTONS SECTION -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="profile.html" class="text-gray-600 hover:text-blue-500 px-3 py-2 rounded-md text-sm font-medium transition">My Account</a>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition">Log Out</button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content Wrapper -->
    <div class="main-container">
        <div class="page-wrapper">
            <div class="booking-container">
                <div id="step-placeholder"></div>
            </div>
            <div class="summary-container hidden">
                <div id="summary-placeholder"></div>
            </div>
        </div>
    </div>

    <!-- Main script for the page -->
    <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAjKL8-QPcOKIXCC9L3K9EVRy2LfAcEhxI",
      authDomain: "sweet-africa-bookings.firebaseapp.com",
      projectId: "sweet-africa-bookings",
      storageBucket: "sweet-africa-bookings.firebasestorage.app",
      messagingSenderId: "950167391030",
      appId: "1:950167391030:web:1085602775ce912d220197"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Make key functions and objects globally available for modular scripts
    window.db = db;
    window.firebase = { collection, addDoc };
    window.loadStep = loadStep;
    window.updateSummary = updateSummary;

    // --- STATE MANAGEMENT & PRICING ---
    const savedState = sessionStorage.getItem('bookingState');
    const bookingState = savedState ? JSON.parse(savedState) : {
        industry: 'Home Cleaning', service: 'Standard Clean', bedrooms: 1, bathrooms: 1, extras: [],
        isPartialCleaning: false, excludedItems: {}, date: 'Not Selected', time: 'Not Selected',
        customerName: '', customerEmail: '', customerPhone: '', customerAddress: '', customerApartment: ''
    };
    window.bookingState = bookingState; // Make state globally available

    const pricing = {
        basePrice: 25.00, perBedroom: 15.50, perBathroom: 20.25,
        extras: { organization: 30.00, laundry: 25.00, dishes: 20.00 },
        deductions: { bedroom: -5.00, fullBathroom: -10.00, halfBathroom: -7.00, kitchen: -12.00, livingRoom: -8.00, basement: -20.00 }
    };

    function calculatePrice() {
        let total = pricing.basePrice;
        total += ((bookingState.bedrooms || 0) * pricing.perBedroom);
        total += ((bookingState.bathrooms || 0) * pricing.perBathroom);
        bookingState.extras.forEach(extra => { total += (pricing.extras[extra] || 0); });
        if (bookingState.isPartialCleaning) {
            for (const item in bookingState.excludedItems) {
                total += ((bookingState.excludedItems[item] || 0) * (pricing.deductions[item] || 0));
            }
        }
        return Math.max(total, 0);
    }

    function updateSummary() {
        const summaryCard = document.getElementById("summary-placeholder");
        if (!summaryCard || !summaryCard.innerHTML) return;
        sessionStorage.setItem('bookingState', JSON.stringify(bookingState));
        document.getElementById('summary-industry').textContent = bookingState.industry;
        document.getElementById('summary-service').textContent = bookingState.service;
        document.getElementById('summary-bedrooms').textContent = bookingState.bedrooms;
        document.getElementById('summary-bathrooms').textContent = bookingState.bathrooms;
        document.getElementById('summary-date').textContent = bookingState.date;
        document.getElementById('summary-time').textContent = bookingState.time;
        document.getElementById('summary-name').textContent = bookingState.customerName || '-';
        document.getElementById('summary-email').textContent = bookingState.customerEmail || '-';
        document.getElementById('summary-phone').textContent = bookingState.customerPhone || '-';
        const fullAddress = bookingState.customerApartment ? `${bookingState.customerAddress}, ${bookingState.customerApartment}` : bookingState.customerAddress;
        document.getElementById('summary-address').textContent = fullAddress || '-';
        const finalPrice = calculatePrice();
        const formattedPrice = `$${finalPrice.toFixed(2)}`;
        document.getElementById('summary-subtotal').textContent = formattedPrice;
        document.getElementById('summary-total').textContent = formattedPrice;
        const extrasListDiv = document.getElementById('summary-extras-list');
        extrasListDiv.innerHTML = '';
        bookingState.extras.forEach(name => {
            const el = document.createElement('div');
            el.classList.add('summary-item');
            el.innerHTML = `<span>${name.charAt(0).toUpperCase() + name.slice(1)}</span><span>+ $${pricing.extras[name].toFixed(2)}</span>`;
            extrasListDiv.appendChild(el);
        });
        if (bookingState.isPartialCleaning) {
            for (const item in bookingState.excludedItems) {
                if (bookingState.excludedItems[item] > 0) {
                    const count = bookingState.excludedItems[item];
                    const deduction = pricing.deductions[item];
                    const itemName = item.replace(/([A-Z])/g, ' $1').trim();
                    const el = document.createElement('div');
                    el.classList.add('summary-item');
                    el.innerHTML = `<span>- ${count} ${itemName}</span><span>- $${(Math.abs(deduction) * count).toFixed(2)}</span>`;
                    extrasListDiv.appendChild(el);
                }
            }
        }
    }

    // --- DYNAMIC PAGE LOADING LOGIC ---
    let currentStepName = '';
    function cleanupStep(stepName) {
      const oldCss = document.getElementById(`${stepName}-css`); if (oldCss) oldCss.remove();
      const oldJs = document.getElementById(`${stepName}-js`); if (oldJs) oldJs.remove();
    }
    
    function loadStep(stepName) {
      if (currentStepName) cleanupStep(currentStepName);
      currentStepName = stepName;
      sessionStorage.setItem('lastVisitedStep', stepName);
      const summaryContainer = document.querySelector('.summary-container');
      if (summaryContainer) {
          summaryContainer.classList.toggle('hidden', stepName === 'step1_service');
      }
      updateSummary();
      const placeholder = document.getElementById('step-placeholder');
      if (!placeholder) return;
      fetch(`sections/${stepName}/${stepName}.html`)
        .then(res => res.ok ? res.text() : Promise.reject(res.statusText))
        .then(html => {
          placeholder.innerHTML = html;
          const cssLink = document.createElement("link");
          cssLink.rel = "stylesheet"; cssLink.id = `${stepName}-css`; cssLink.href = `sections/${stepName}/${stepName}.css`;
          document.head.appendChild(cssLink);
          fetch(`sections/${stepName}/${stepName}.js`).then(res => {
            if (res.ok) {
              const script = document.createElement("script");
              script.id = `${stepName}-js`; script.src = `sections/${stepName}/${stepName}.js?v=${new Date().getTime()}`;
              document.body.appendChild(script);
            }
          });
        }).catch(error => console.error(`Failed to load step ${stepName}:`, error));
    }
    
    function loadSummaryCard() {
      const placeholder = document.getElementById("summary-placeholder");
      if (!placeholder) return;
      return fetch("sections/summary_card/summary_card.html")
        .then(res => res.ok ? res.text() : Promise.reject(res.statusText))
        .then(html => {
          placeholder.innerHTML = html;
          const cssLink = document.createElement("link");
          cssLink.rel = "stylesheet"; cssLink.href = "sections/summary_card/summary_card.css";
          document.head.appendChild(cssLink);
        }).catch(error => console.error('Failed to load summary card:', error));
    }

    // Main app loader function
    function loadApp() {
        const logoutButton = document.getElementById('logout-button');
        if(logoutButton) {
            logoutButton.addEventListener('click', () => {
                signOut(auth).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });
        }
        
        loadSummaryCard().then(() => {
            const savedStep = sessionStorage.getItem('lastVisitedStep');
            loadStep(savedStep || 'step1_service');
        });
    }

    // --- AUTHENTICATION CHECK ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in, pre-populate state with their details from Firestore
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                bookingState.customerName = userData.name || '';
                bookingState.customerEmail = userData.email || '';
                // Add any other fields you want to pre-populate
            }
            // Now that user is confirmed and data is pre-populated, load the app
            loadApp();
        } else {
            // User is signed out, redirect to login page
            window.location.href = 'login.html';
        }
    });
</script>

</body>
</html>